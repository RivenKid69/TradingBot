# Hour-of-Week Seasonality

Certain hours of the week exhibit systematic patterns in market depth, bid-ask spreads and order-processing delays. To capture this behaviour, the simulator supports **hour-of-week multipliers** that scale baseline liquidity, spread and latency parameters. Multipliers are indexed from `0` (Monday 00:00 UTC) to `167` (Sunday 23:00 UTC).

## `liquidity_latency_seasonality.json` format

The JSON file contains up to three arrays with 168 floating-point numbers each:

```json
{
  "liquidity": [1.0, 1.1, ...],
  "latency":   [1.0, 0.9, ...],
  "spread":    [1.0, 0.8, ...]
}
```

`liquidity` multiplies available volume, `latency` scales simulated execution delays while `spread` adjusts the baseline bid-ask spread (in bps). Missing arrays or indices default to `1.0`.

## Regenerating multipliers from historical data

1. Prepare a CSV or Parquet file with columns such as `ts_ms`, `quantity`, `latency_ms` or `spread_bps`.
2. Run the helper script to compute averages for each hour of week and normalise them:

   ```bash
   python scripts/build_hourly_seasonality.py --data path/to/trades.parquet --out configs/liquidity_latency_seasonality.json
   ```
3. Optionally verify the multipliers against the original dataset:

   ```bash
   python scripts/validate_seasonality.py --historical path/to/trades.parquet --multipliers configs/liquidity_latency_seasonality.json
   ```

## Enabling seasonality in configs

Seasonality can be activated either via CLI flags or directly in YAML configs:

```bash
python script_backtest.py --config configs/config_sim.yaml --liquidity-seasonality configs/liquidity_latency_seasonality.json
```

```yaml
liquidity_seasonality_path: "configs/liquidity_latency_seasonality.json"

latency:
  seasonality_path: "configs/liquidity_latency_seasonality.json"
```

## Disabling seasonality

Hourly multipliers are enabled by default. To ignore them, set the
`use_seasonality` flag to `false` either globally or within the latency
section of your config:

```yaml
use_seasonality: false          # disable liquidity and spread multipliers

latency:
  use_seasonality: false        # disable latency multipliers
```

The same flag can be passed as a constructor argument to
`ExecutionSimulator` or `LatencyImpl`.

## Seeds and determinism

The latency model's random draws are controlled by the `seed` field in
the `latency` section of simulation configs. Hourly multipliers only
scale deterministic parameters and do not reseed or otherwise affect the
random number generator. Runs executed with the same `seed` and
multiplier set will therefore produce identical latency samples.

## Data storage and retention

Raw historical snapshots used to derive the multipliers are stored under
`data/seasonality_source/`. Each snapshot should be accompanied by a
`<filename>.sha256` file generated by the helper scripts to allow
auditing of the inputs.

Retain at least 12 months of snapshots so that previous seasonality runs
can be reproduced. Snapshot sizes depend on the exchange feed but
typically require several hundred megabytes per month; plan storage
accordingly.
